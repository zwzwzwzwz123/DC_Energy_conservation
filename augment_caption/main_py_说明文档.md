# main.py è¯¦ç»†è¯´æ˜æ–‡æ¡£

## ğŸ“š ç›®å½•

1. [æ–‡ä»¶æ¦‚è¿°](#1-æ–‡ä»¶æ¦‚è¿°)
2. [å¯¼å…¥æ¨¡å—è¯¦è§£](#2-å¯¼å…¥æ¨¡å—è¯¦è§£)
3. [å…¨å±€å˜é‡å’Œå¸¸é‡](#3-å…¨å±€å˜é‡å’Œå¸¸é‡)
4. [AppContext ç±»è¯¦è§£](#4-appcontext-ç±»è¯¦è§£)
5. [çº¿ç¨‹å‡½æ•°è¯¦è§£](#5-çº¿ç¨‹å‡½æ•°è¯¦è§£)
6. [main å‡½æ•°è¯¦è§£](#6-main-å‡½æ•°è¯¦è§£)
7. [ä»£ç æ‰§è¡Œæµç¨‹](#7-ä»£ç æ‰§è¡Œæµç¨‹)
8. [ä¸å…¶ä»–æ¨¡å—çš„äº¤äº’](#8-ä¸å…¶ä»–æ¨¡å—çš„äº¤äº’)
9. [Python è¯­æ³•å’Œæ¦‚å¿µè§£é‡Š](#9-python-è¯­æ³•å’Œæ¦‚å¿µè§£é‡Š)
10. [å¸¸è§é—®é¢˜è§£ç­”](#10-å¸¸è§é—®é¢˜è§£ç­”)

---

## 1. æ–‡ä»¶æ¦‚è¿°

### 1.1 æ–‡ä»¶ä½œç”¨

`main.py` æ˜¯æ•´ä¸ªæ•°æ®ä¸­å¿ƒèŠ‚èƒ½é¡¹ç›®çš„**ä¸»ç¨‹åºå…¥å£**,è´Ÿè´£:

- **åˆå§‹åŒ–ç³»ç»Ÿ**: åŠ è½½é…ç½®æ–‡ä»¶ã€åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿã€è¿æ¥æ•°æ®åº“
- **å¯åŠ¨å¤šçº¿ç¨‹**: åˆ›å»ºå¹¶ç®¡ç†ä¸‰ä¸ªå·¥ä½œçº¿ç¨‹(é¢„æµ‹è®­ç»ƒã€é¢„æµ‹æ¨ç†ã€ä¼˜åŒ–)
- **åè°ƒè¿è¡Œ**: åè°ƒå„ä¸ªæ¨¡å—çš„è¿è¡Œ,ç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ
- **ä¼˜é›…å…³é—­**: å¤„ç†é€€å‡ºä¿¡å·,ç¡®ä¿æ‰€æœ‰èµ„æºæ­£ç¡®é‡Šæ”¾

### 1.2 åœ¨é¡¹ç›®ä¸­çš„ä½ç½®

```
DC_Energy_conservation/
â”œâ”€â”€ DC_Energy_conservation/
â”‚   â””â”€â”€ main.py          â† ä¸»ç¨‹åºå…¥å£(æœ¬æ–‡ä»¶)
â”œâ”€â”€ configs/             â† é…ç½®æ–‡ä»¶ç›®å½•
â”œâ”€â”€ utils/               â† å·¥å…·æ¨¡å—ç›®å½•
â”œâ”€â”€ modules/             â† åŠŸèƒ½æ¨¡å—ç›®å½•
â”œâ”€â”€ models/              â† æ¨¡å‹æ–‡ä»¶ç›®å½•
â””â”€â”€ logs/                â† æ—¥å¿—æ–‡ä»¶ç›®å½•
```

### 1.3 è¿è¡Œæ–¹å¼

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œ
uv run DC_Energy_conservation/main.py

# æˆ–è€…ä½¿ç”¨ Python ç›´æ¥è¿è¡Œ
python DC_Energy_conservation/main.py
```

---

## 2. å¯¼å…¥æ¨¡å—è¯¦è§£

### 2.1 Python æ ‡å‡†åº“

```python
import sys                    # ç³»ç»Ÿç›¸å…³åŠŸèƒ½(å¦‚é€€å‡ºç¨‹åºã€ä¿®æ”¹è·¯å¾„)
import time                   # æ—¶é—´ç›¸å…³åŠŸèƒ½(å¦‚ç¡çœ ã€è®¡æ—¶)
import logging                # æ—¥å¿—è®°å½•åŠŸèƒ½
from pathlib import Path      # è·¯å¾„æ“ä½œ(æ¯”å­—ç¬¦ä¸²æ‹¼æ¥æ›´å®‰å…¨)
from threading import Thread, Event, Lock  # å¤šçº¿ç¨‹ç›¸å…³
from concurrent.futures import ThreadPoolExecutor, TimeoutError as FutureTimeoutError  # çº¿ç¨‹æ± 
from dataclasses import dataclass, field  # æ•°æ®ç±»è£…é¥°å™¨
from typing import Dict, Any  # ç±»å‹æç¤º
```

**æ–°æ‰‹è§£é‡Š**:
- `sys`: æä¾›ä¸ Python è§£é‡Šå™¨äº¤äº’çš„åŠŸèƒ½,å¦‚ `sys.exit()` é€€å‡ºç¨‹åº
- `time`: æä¾›æ—¶é—´ç›¸å…³åŠŸèƒ½,å¦‚ `time.sleep(5)` æš‚åœ 5 ç§’
- `logging`: Python çš„æ—¥å¿—ç³»ç»Ÿ,æ¯” `print()` æ›´ä¸“ä¸š
- `Path`: ç°ä»£åŒ–çš„è·¯å¾„æ“ä½œæ–¹å¼,è‡ªåŠ¨å¤„ç†ä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„åˆ†éš”ç¬¦
- `threading`: Python çš„å¤šçº¿ç¨‹æ¨¡å—,ç”¨äºå¹¶å‘æ‰§è¡Œä»»åŠ¡
- `dataclasses`: ç®€åŒ–æ•°æ®ç±»çš„å®šä¹‰,è‡ªåŠ¨ç”Ÿæˆ `__init__` ç­‰æ–¹æ³•

### 2.2 é¡¹ç›®è‡ªå®šä¹‰æ¨¡å—

```python
from utils.initialization import init_multi_level_loggers, load_configs
from utils.influxdb_wrapper import init_influxdb_clients, InfluxDBClientWrapper
from utils.critical_operation import critical_operation, wait_for_critical_operations
from utils.architecture_config_parser import load_datacenter_from_config
from utils.data_read_write import create_data_reader, create_data_writer
from modules.architecture_module import DataCenter
```

**æ¨¡å—åŠŸèƒ½è¯´æ˜**:

| æ¨¡å— | å¯¼å…¥çš„å‡½æ•°/ç±» | åŠŸèƒ½ |
|------|--------------|------|
| `utils.initialization` | `init_multi_level_loggers` | åˆå§‹åŒ–å¤šå±‚çº§æ—¥å¿—ç³»ç»Ÿ |
| | `load_configs` | åŠ è½½æ‰€æœ‰é…ç½®æ–‡ä»¶ |
| `utils.influxdb_wrapper` | `init_influxdb_clients` | åˆå§‹åŒ– InfluxDB å®¢æˆ·ç«¯ |
| | `InfluxDBClientWrapper` | InfluxDB å®¢æˆ·ç«¯åŒ…è£…ç±» |
| `utils.critical_operation` | `critical_operation` | å…³é”®æ“ä½œä¿æŠ¤ä¸Šä¸‹æ–‡ç®¡ç†å™¨ |
| | `wait_for_critical_operations` | ç­‰å¾…æ‰€æœ‰å…³é”®æ“ä½œå®Œæˆ |
| `utils.architecture_config_parser` | `load_datacenter_from_config` | ä»é…ç½®æ–‡ä»¶åŠ è½½æ•°æ®ä¸­å¿ƒå¯¹è±¡ |
| `utils.data_read_write` | `create_data_reader` | åˆ›å»ºæ•°æ®è¯»å–å™¨ |
| | `create_data_writer` | åˆ›å»ºæ•°æ®å†™å…¥å™¨ |
| `modules.architecture_module` | `DataCenter` | æ•°æ®ä¸­å¿ƒç±» |

---

## 3. å…¨å±€å˜é‡å’Œå¸¸é‡

### 3.1 é¡¹ç›®æ ¹ç›®å½•

```python
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))
```

**è§£é‡Š**:
- `__file__`: å½“å‰æ–‡ä»¶çš„è·¯å¾„(main.py)
- `.parent`: è·å–çˆ¶ç›®å½•
- `.parent.parent`: è·å–çˆ¶ç›®å½•çš„çˆ¶ç›®å½•(é¡¹ç›®æ ¹ç›®å½•)
- `sys.path.insert(0, ...)`: å°†é¡¹ç›®æ ¹ç›®å½•æ·»åŠ åˆ° Python æ¨¡å—æœç´¢è·¯å¾„çš„æœ€å‰é¢

**ä¸ºä»€ä¹ˆè¿™æ ·åš?**
ç¡®ä¿ Python èƒ½å¤Ÿæ­£ç¡®å¯¼å…¥é¡¹ç›®ä¸­çš„è‡ªå®šä¹‰æ¨¡å—,æ— è®ºä»å“ªä¸ªç›®å½•è¿è¡Œç¨‹åºã€‚

**ç¤ºä¾‹**:
```
å‡è®¾æ–‡ä»¶ç»“æ„:
/home/user/DC_Energy_conservation/DC_Energy_conservation/main.py

åˆ™:
__file__ = "/home/user/DC_Energy_conservation/DC_Energy_conservation/main.py"
Path(__file__).parent = "/home/user/DC_Energy_conservation/DC_Energy_conservation"
Path(__file__).parent.parent = "/home/user/DC_Energy_conservation"
```

---

## 4. AppContext ç±»è¯¦è§£

### 4.1 ä»€ä¹ˆæ˜¯ AppContext?

`AppContext` æ˜¯ä¸€ä¸ª**åº”ç”¨ä¸Šä¸‹æ–‡ç±»**,ç”¨äºå°è£…ç¨‹åºè¿è¡Œæ—¶éœ€è¦çš„æ‰€æœ‰å…¨å±€çŠ¶æ€å’Œèµ„æºã€‚

**ç±»æ¯”**: å°±åƒä¸€ä¸ª"å·¥å…·ç®±",é‡Œé¢è£…ç€ç¨‹åºè¿è¡Œéœ€è¦çš„æ‰€æœ‰å·¥å…·(æ—¥å¿—å™¨ã€æ•°æ®åº“è¿æ¥ã€é…ç½®ç­‰)ã€‚

### 4.2 ç±»å®šä¹‰

```python
@dataclass
class AppContext:
    """åº”ç”¨ä¸Šä¸‹æ–‡ç±»ï¼Œå°è£…æ‰€æœ‰å…¨å±€çŠ¶æ€"""
    loggers: Dict[str, logging.Logger]           # æ—¥å¿—å™¨å­—å…¸
    dc_status_client: InfluxDBClientWrapper      # æ•°æ®ä¸­å¿ƒçŠ¶æ€æ•°æ®å®¢æˆ·ç«¯
    prediction_client: InfluxDBClientWrapper     # é¢„æµ‹æ•°æ®å®¢æˆ·ç«¯
    optimization_client: InfluxDBClientWrapper   # ä¼˜åŒ–æ•°æ®å®¢æˆ·ç«¯
    shutdown_event: Event                        # å…³é—­äº‹ä»¶
    main_config: Dict                            # ä¸»é…ç½®å­—å…¸
    critical_operation_lock: Lock = field(default_factory=Lock)  # å…³é”®æ“ä½œé”
    critical_operation_count: int = 0            # å…³é”®æ“ä½œè®¡æ•°
    datacenter: DataCenter = None                # æ•°æ®ä¸­å¿ƒå¯¹è±¡
    data_reader: Any = None                      # æ•°æ®è¯»å–å™¨
    data_writer: Any = None                      # æ•°æ®å†™å…¥å™¨
```

### 4.3 å±æ€§è¯¦è§£

#### 4.3.1 loggers (æ—¥å¿—å™¨å­—å…¸)

**ç±»å‹**: `Dict[str, logging.Logger]`

**ä½œç”¨**: å­˜å‚¨æ‰€æœ‰æ—¥å¿—å™¨,ç”¨äºè®°å½•ä¸åŒæ¨¡å—çš„æ—¥å¿—ã€‚

**åŒ…å«çš„æ—¥å¿—å™¨**:
- `"total"`: æ€»æ—¥å¿—å™¨(è®°å½•æ‰€æœ‰æ—¥å¿—)
- `"main"`: ä¸»ç¨‹åºæ—¥å¿—å™¨
- `"influxdb"`: InfluxDB æ—¥å¿—å™¨
- `"prediction_training"`: é¢„æµ‹è®­ç»ƒçº¿ç¨‹æ—¥å¿—å™¨
- `"prediction_inference"`: é¢„æµ‹æ¨ç†çº¿ç¨‹æ—¥å¿—å™¨
- `"optimization"`: ä¼˜åŒ–çº¿ç¨‹æ—¥å¿—å™¨

**ä½¿ç”¨ç¤ºä¾‹**:
```python
ctx.loggers["main"].info("ä¸»ç¨‹åºå¯åŠ¨")  # è®°å½•ä¿¡æ¯çº§åˆ«æ—¥å¿—
ctx.loggers["main"].error("å‘ç”Ÿé”™è¯¯")   # è®°å½•é”™è¯¯çº§åˆ«æ—¥å¿—
```

#### 4.3.2 InfluxDB å®¢æˆ·ç«¯

**dc_status_client**: ç”¨äºè¯»å–æ•°æ®ä¸­å¿ƒçŠ¶æ€æ•°æ®(æ¸©åº¦ã€æ¹¿åº¦ã€åŠŸç‡ç­‰)
**prediction_client**: ç”¨äºè¯»å†™é¢„æµ‹æ•°æ®(æœªæ¥æ¸©åº¦é¢„æµ‹ç­‰)
**optimization_client**: ç”¨äºå†™å…¥ä¼˜åŒ–æ§åˆ¶æŒ‡ä»¤(ç©ºè°ƒè®¾å®šæ¸©åº¦ç­‰)

**ä¸ºä»€ä¹ˆéœ€è¦ä¸‰ä¸ªå®¢æˆ·ç«¯?**
- æ•°æ®éš”ç¦»: ä¸åŒç±»å‹çš„æ•°æ®å­˜å‚¨åœ¨ä¸åŒçš„æ•°æ®åº“ä¸­
- æƒé™æ§åˆ¶: ä¸åŒå®¢æˆ·ç«¯å¯ä»¥æœ‰ä¸åŒçš„è¯»å†™æƒé™
- æ€§èƒ½ä¼˜åŒ–: é¿å…å•ä¸ªæ•°æ®åº“è¿‡è½½

#### 4.3.3 shutdown_event (å…³é—­äº‹ä»¶)

**ç±»å‹**: `threading.Event`

**ä½œç”¨**: ç”¨äºé€šçŸ¥æ‰€æœ‰çº¿ç¨‹ä¼˜é›…é€€å‡ºã€‚

**å·¥ä½œåŸç†**:
1. åˆå§‹çŠ¶æ€: `shutdown_event.is_set()` è¿”å› `False`
2. æŒ‰ä¸‹ Ctrl+C: ä¸»çº¿ç¨‹è°ƒç”¨ `shutdown_event.set()`
3. å·¥ä½œçº¿ç¨‹æ£€æŸ¥: `if ctx.shutdown_event.is_set(): break`
4. çº¿ç¨‹é€€å‡º: æ‰€æœ‰çº¿ç¨‹æ£€æµ‹åˆ°ä¿¡å·åé€€å‡ºå¾ªç¯

**ç¤ºä¾‹**:
```python
# ä¸»çº¿ç¨‹
shutdown_event.set()  # å‘é€å…³é—­ä¿¡å·

# å·¥ä½œçº¿ç¨‹
while not ctx.shutdown_event.is_set():
    # æ‰§è¡Œä»»åŠ¡
    pass
# é€€å‡ºå¾ªç¯
```

#### 4.3.4 critical_operation_lock å’Œ critical_operation_count

**ä½œç”¨**: ä¿æŠ¤å…³é”®æ“ä½œ(å¦‚æ•°æ®åº“å†™å…¥ã€æ¨¡å‹ä¿å­˜),ç¡®ä¿è¿™äº›æ“ä½œä¸ä¼šè¢«ä¸­æ–­ã€‚

**å·¥ä½œåŸç†**:
1. è¿›å…¥å…³é”®æ“ä½œ: `critical_operation_count += 1`
2. æ‰§è¡Œå…³é”®æ“ä½œ: å†™å…¥æ•°æ®åº“æˆ–ä¿å­˜æ¨¡å‹
3. é€€å‡ºå…³é”®æ“ä½œ: `critical_operation_count -= 1`
4. ç¨‹åºå…³é—­æ—¶: ç­‰å¾… `critical_operation_count` å˜ä¸º 0

**ä¸ºä»€ä¹ˆéœ€è¦é”?**
å¤šä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶ä¿®æ”¹ `critical_operation_count`,ä½¿ç”¨é”ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚

---

## 5. çº¿ç¨‹å‡½æ•°è¯¦è§£

æœ¬ç¨‹åºä½¿ç”¨**å¤šçº¿ç¨‹æ¶æ„**,åŒæ—¶è¿è¡Œä¸‰ä¸ªå·¥ä½œçº¿ç¨‹:

1. **é¢„æµ‹è®­ç»ƒçº¿ç¨‹** (`prediction_training_thread`): è®­ç»ƒé¢„æµ‹æ¨¡å‹
2. **é¢„æµ‹æ¨ç†çº¿ç¨‹** (`prediction_inference_thread`): æ‰§è¡Œé¢„æµ‹æ¨ç†
3. **ä¼˜åŒ–çº¿ç¨‹** (`optimization_thread`): æ‰§è¡Œä¼˜åŒ–ç®—æ³•

### 5.1 é¢„æµ‹è®­ç»ƒçº¿ç¨‹ (prediction_training_thread)

#### 5.1.1 å‡½æ•°ç­¾å

```python
def prediction_training_thread(ctx: AppContext):
    """
    é¢„æµ‹è®­ç»ƒçº¿ç¨‹ - ä» InfluxDB è¯»å–æ•°æ®ä¸­å¿ƒçŠ¶æ€å¹¶è®­ç»ƒé¢„æµ‹æ¨¡å‹
    
    å‚æ•°:
        ctx: åº”ç”¨ä¸Šä¸‹æ–‡ï¼ŒåŒ…å« loggersã€InfluxDB å®¢æˆ·ç«¯å’Œ shutdown_event
    """
```

#### 5.1.2 ä¸»è¦æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯»å–é…ç½®(è¿è¡Œæ¨¡å¼ã€æ—¶é—´é—´éš”ç­‰)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¿›å…¥ä¸»å¾ªç¯(while not shutdown_event) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è¯»å–è®­ç»ƒæ•°æ®(ä» InfluxDB)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ•°æ®é¢„å¤„ç†(TODO: å¾…å®ç°)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ¨¡å‹è®­ç»ƒ(TODO: å¾…å®ç°)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. æ¨¡å‹ä¿å­˜(TODO: å¾…å®ç°)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ç­‰å¾…ä¸‹ä¸€æ¬¡å¾ªç¯(æ ¹æ®è¿è¡Œæ¨¡å¼)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.1.3 è¿è¡Œæ¨¡å¼

ç¨‹åºæ”¯æŒä¸¤ç§è¿è¡Œæ¨¡å¼,åœ¨ `configs/main_config.yaml` ä¸­é…ç½®:

**1. å›ºå®šæ—¶é—´é—´éš”æ¨¡å¼ (fixed_interval)**

```yaml
prediction_training:
  mode: "fixed_interval"
  interval: 3600  # æ¯ 3600 ç§’(1 å°æ—¶)è¿è¡Œä¸€æ¬¡
```

**å·¥ä½œåŸç†**:
- å¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´ < interval: ç­‰å¾…å‰©ä½™æ—¶é—´
- å¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´ >= interval: ç«‹å³å¼€å§‹ä¸‹ä¸€æ¬¡å¾ªç¯

**ç¤ºä¾‹**:
```
interval = 3600 ç§’(1 å°æ—¶)

æƒ…å†µ 1: ä»»åŠ¡æ‰§è¡Œäº† 30 åˆ†é’Ÿ
  â†’ ç­‰å¾… 30 åˆ†é’Ÿåå¼€å§‹ä¸‹ä¸€æ¬¡å¾ªç¯
  â†’ æ€»å‘¨æœŸ = 1 å°æ—¶

æƒ…å†µ 2: ä»»åŠ¡æ‰§è¡Œäº† 1.5 å°æ—¶
  â†’ ç«‹å³å¼€å§‹ä¸‹ä¸€æ¬¡å¾ªç¯
  â†’ æ€»å‘¨æœŸ = 1.5 å°æ—¶
```

**2. è¿ç»­è¿è¡Œæ¨¡å¼ (continuous)**

```yaml
prediction_training:
  mode: "continuous"
```

**å·¥ä½œåŸç†**:
ä»»åŠ¡å®Œæˆåç«‹å³å¼€å§‹ä¸‹ä¸€æ¬¡å¾ªç¯,ä¸ç­‰å¾…ã€‚

#### 5.1.4 å…³é”®ä»£ç è§£æ

**è¯»å–è®­ç»ƒæ•°æ®**:

```python
telemetry_data = ctx.data_reader.read_all_observable_data()
logger.info(f"æˆåŠŸè¯»å– {len(telemetry_data)} ä¸ªé¥æµ‹ç‚¹çš„æ•°æ®")
```

**è§£é‡Š**:
- `ctx.data_reader`: æ•°æ®è¯»å–å™¨å¯¹è±¡
- `read_all_observable_data()`: è¯»å–æ‰€æœ‰é¥æµ‹æ•°æ®(æ¸©åº¦ã€æ¹¿åº¦ã€åŠŸç‡ç­‰)
- è¿”å›å€¼: `Dict[str, pd.DataFrame]`,é”®æ˜¯é¥æµ‹ç‚¹ UID,å€¼æ˜¯ Pandas DataFrame

**æ•°æ®éªŒè¯**:
```python
if not telemetry_data:
    logger.warning("æ²¡æœ‰è¯»å–åˆ°ä»»ä½•æ•°æ®ï¼Œè·³è¿‡æœ¬æ¬¡è®­ç»ƒ")
    continue  # è·³è¿‡æœ¬æ¬¡å¾ªç¯,è¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯
```

**ç­‰å¾…æœºåˆ¶**:
```python
elapsed_time = time.time() - loop_start_time  # è®¡ç®—å·²ç”¨æ—¶é—´
remaining_time = interval - elapsed_time      # è®¡ç®—å‰©ä½™æ—¶é—´

if remaining_time > 0:
    # ç­‰å¾…å‰©ä½™æ—¶é—´,å¦‚æœæ”¶åˆ°å…³é—­ä¿¡å·åˆ™é€€å‡º
    if ctx.shutdown_event.wait(timeout=remaining_time):
        break  # é€€å‡ºå¾ªç¯
```

**è§£é‡Š**:
- `shutdown_event.wait(timeout=...)`: ç­‰å¾…æŒ‡å®šæ—¶é—´,å¦‚æœæœŸé—´æ”¶åˆ°å…³é—­ä¿¡å·åˆ™è¿”å› `True`
- è¿™æ ·å¯ä»¥åœ¨ç­‰å¾…æœŸé—´å“åº” Ctrl+C é€€å‡ºä¿¡å·

### 5.2 é¢„æµ‹æ¨ç†çº¿ç¨‹ (prediction_inference_thread)

#### 5.2.1 ä¸»è¦æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯»å–æ¨ç†æ•°æ®(æœ€æ–°æ•°æ®)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åŠ è½½é¢„æµ‹æ¨¡å‹(TODO: å¾…å®ç°)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ‰§è¡Œé¢„æµ‹æ¨ç†(TODO: å¾…å®ç°)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å†™å…¥é¢„æµ‹ç»“æœåˆ° InfluxDB              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.2.2 å†™å…¥é¢„æµ‹ç»“æœ

```python
success = ctx.data_writer.write_prediction_data(
    prediction_data=prediction_results,
    data_type='temperature_prediction'
)
```

**è§£é‡Š**:
- `ctx.data_writer`: æ•°æ®å†™å…¥å™¨å¯¹è±¡
- `write_prediction_data()`: å†™å…¥é¢„æµ‹æ•°æ®åˆ° InfluxDB
- è¯¥æ–¹æ³•å†…éƒ¨å·²ä½¿ç”¨ `critical_operation` ä¿æŠ¤,ç¡®ä¿å†™å…¥æ“ä½œä¸ä¼šè¢«ä¸­æ–­

### 5.3 ä¼˜åŒ–çº¿ç¨‹ (optimization_thread)

#### 5.3.1 ä¸»è¦æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¯»å–é¢„æµ‹æ•°æ®(ä» prediction_client)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. è¯»å–å½“å‰çŠ¶æ€æ•°æ®(ä» dc_status_client)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ‰§è¡Œä¼˜åŒ–ç®—æ³•(TODO: å¾…å®ç°)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å†™å…¥æ§åˆ¶æŒ‡ä»¤åˆ° InfluxDB              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.3.2 å†™å…¥æ§åˆ¶æŒ‡ä»¤

```python
success = ctx.data_writer.write_optimization_commands(
    control_commands=control_commands
)
```

---

## 6. main å‡½æ•°è¯¦è§£

### 6.1 åˆå§‹åŒ–æµç¨‹

`main()` å‡½æ•°æ˜¯ç¨‹åºçš„å…¥å£,è´Ÿè´£åˆå§‹åŒ–ç³»ç»Ÿå¹¶å¯åŠ¨å¤šçº¿ç¨‹ã€‚

**å®Œæ•´æµç¨‹**:

```
[1/6] åŠ è½½é…ç½®æ–‡ä»¶
  â†“
[2/6] åˆå§‹åŒ–å¤šå±‚çº§æ—¥å¿—ç³»ç»Ÿ
  â†“
[3/6] åˆå§‹åŒ– InfluxDB å®¢æˆ·ç«¯
  â†“
[4/6] åŠ è½½æ•°æ®ä¸­å¿ƒé…ç½®
  â†“
[5/6] åˆ›å»ºæ•°æ®è¯»å–å™¨
  â†“
[6/6] åˆ›å»ºæ•°æ®å†™å…¥å™¨
  â†“
å¯åŠ¨å¤šçº¿ç¨‹
  â†“
ç­‰å¾…ä¸­æ–­ä¿¡å·(Ctrl+C)
  â†“
ä¼˜é›…å…³é—­ç³»ç»Ÿ
```

### 6.2 æ­¥éª¤è¯¦è§£

#### æ­¥éª¤ 1: åŠ è½½é…ç½®æ–‡ä»¶

```python
main_config, models_config, modules_config, security_boundary_config, uid_config, utils_config = load_configs()
```

**åŠ è½½çš„é…ç½®æ–‡ä»¶**:
- `main_config.yaml`: ä¸»ç¨‹åºé…ç½®(çº¿ç¨‹å‚æ•°ã€å…³é—­è¶…æ—¶ç­‰)
- `models_config.yaml`: æ¨¡å‹é…ç½®
- `modules_config.yaml`: æ¨¡å—é…ç½®
- `security_boundary_config.yaml`: å®‰å…¨è¾¹ç•Œé…ç½®
- `uid_config.yaml`: æ•°æ®ä¸­å¿ƒæ¶æ„é…ç½®
- `utils_config.yaml`: å·¥å…·é…ç½®(InfluxDBã€æ—¥å¿—ç­‰)

#### æ­¥éª¤ 2: åˆå§‹åŒ–å¤šå±‚çº§æ—¥å¿—ç³»ç»Ÿ

```python
loggers = init_multi_level_loggers(utils_config["logging"])
```

**æ—¥å¿—æ–‡ä»¶**:
- `total_log.log`: è®°å½•æ‰€æœ‰æ—¥å¿—
- `main_log.log`: ä¸»ç¨‹åºæ—¥å¿—
- `influxdb_log.log`: InfluxDB æ—¥å¿—
- `prediction_training_log.log`: é¢„æµ‹è®­ç»ƒæ—¥å¿—
- `prediction_inference_log.log`: é¢„æµ‹æ¨ç†æ—¥å¿—
- `optimization_log.log`: ä¼˜åŒ–æ—¥å¿—

**æ—¥å¿—çº§åˆ«**:
- `DEBUG`: è°ƒè¯•ä¿¡æ¯
- `INFO`: ä¸€èˆ¬ä¿¡æ¯
- `WARNING`: è­¦å‘Šä¿¡æ¯
- `ERROR`: é”™è¯¯ä¿¡æ¯
- `CRITICAL`: ä¸¥é‡é”™è¯¯

#### æ­¥éª¤ 3: åˆå§‹åŒ– InfluxDB å®¢æˆ·ç«¯

```python
dc_status_client, prediction_client, optimization_client = init_influxdb_clients(
    utils_config, loggers["influxdb"]
)
```

**ä¸‰ä¸ªå®¢æˆ·ç«¯**:
1. `dc_status_client`: è¯»å–æ•°æ®ä¸­å¿ƒçŠ¶æ€æ•°æ®
2. `prediction_client`: è¯»å†™é¢„æµ‹æ•°æ®
3. `optimization_client`: å†™å…¥ä¼˜åŒ–æ§åˆ¶æŒ‡ä»¤

#### æ­¥éª¤ 4: åŠ è½½æ•°æ®ä¸­å¿ƒé…ç½®

```python
datacenter = load_datacenter_from_config(str(uid_config_path))
```

**åŠ è½½å†…å®¹**:
- æ•°æ®ä¸­å¿ƒå±‚æ¬¡ç»“æ„(æœºæˆ¿ã€ç³»ç»Ÿã€è®¾å¤‡)
- æ‰€æœ‰é¥æµ‹ç‚¹å’Œæ§åˆ¶ç‚¹çš„ UID
- è®¾å¤‡å±æ€§å’Œå‚æ•°

**ç»Ÿè®¡ä¿¡æ¯**:
```python
stats = datacenter.get_statistics()
print(f"æœºæˆ¿æ€»æ•°: {stats['total_rooms']}")
print(f"è®¾å¤‡æ€»æ•°: {stats['total_devices']}")
print(f"é¥æµ‹ç‚¹æ€»æ•°: {stats['total_telemetry_points']}")
```

#### æ­¥éª¤ 5-6: åˆ›å»ºæ•°æ®è¯»å–å™¨å’Œå†™å…¥å™¨

```python
data_reader = create_data_reader(datacenter, config_path, dc_status_client)
data_writer = create_data_writer(datacenter, config_path, prediction_client, ctx_temp)
```

### 6.3 å¯åŠ¨å¤šçº¿ç¨‹

```python
executor = ThreadPoolExecutor(max_workers=3, thread_name_prefix="Worker")

future_prediction_training = executor.submit(prediction_training_thread, ctx)
future_prediction_inference = executor.submit(prediction_inference_thread, ctx)
future_optimization = executor.submit(optimization_thread, ctx)
```

**è§£é‡Š**:
- `ThreadPoolExecutor`: çº¿ç¨‹æ± ,ç®¡ç†å¤šä¸ªå·¥ä½œçº¿ç¨‹
- `max_workers=3`: æœ€å¤š 3 ä¸ªå·¥ä½œçº¿ç¨‹
- `executor.submit()`: æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
- è¿”å› `Future` å¯¹è±¡,å¯ä»¥ç”¨æ¥æ£€æŸ¥ä»»åŠ¡çŠ¶æ€

### 6.4 ä¼˜é›…å…³é—­æµç¨‹

å½“ç”¨æˆ·æŒ‰ä¸‹ Ctrl+C æ—¶,ç¨‹åºæ‰§è¡Œä»¥ä¸‹æ­¥éª¤:

```
1. æ•è· KeyboardInterrupt å¼‚å¸¸
   â†“
2. è®¾ç½® shutdown_event,é€šçŸ¥æ‰€æœ‰çº¿ç¨‹é€€å‡º
   â†“
3. ç­‰å¾…å…³é”®æ“ä½œå®Œæˆ(æœ€å¤š 30 ç§’)
   â†“
4. ç­‰å¾…å·¥ä½œçº¿ç¨‹é€€å‡º(æœ€å¤š 5 ç§’)
   â†“
5. å…³é—­ InfluxDB è¿æ¥
   â†“
6. åˆ·æ–°æ‰€æœ‰æ—¥å¿—
   â†“
7. ç¨‹åºé€€å‡º
```

**å…³é”®ä»£ç **:

```python
except KeyboardInterrupt:
    print("\næ¥æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œæ­£åœ¨å…³é—­ç³»ç»Ÿ...")
    shutdown_event.set()  # é€šçŸ¥æ‰€æœ‰çº¿ç¨‹é€€å‡º
    
finally:
    # ç­‰å¾…å…³é”®æ“ä½œå®Œæˆ
    wait_for_critical_operations(ctx, timeout=shutdown_timeout)
    
    # ç­‰å¾…å·¥ä½œçº¿ç¨‹é€€å‡º
    executor.shutdown(wait=False, cancel_futures=True)
    
    # å…³é—­ InfluxDB è¿æ¥
    dc_status_client.close()
    prediction_client.close()
    optimization_client.close()
```

---

## 7. ä»£ç æ‰§è¡Œæµç¨‹

### 7.1 ç¨‹åºå¯åŠ¨æµç¨‹å›¾

```
ç¨‹åºå¯åŠ¨
  â”‚
  â”œâ”€â†’ åŠ è½½é…ç½®æ–‡ä»¶
  â”‚     â””â”€â†’ main_config.yaml, utils_config.yaml, uid_config.yaml ç­‰
  â”‚
  â”œâ”€â†’ åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
  â”‚     â””â”€â†’ åˆ›å»º 6 ä¸ªæ—¥å¿—å™¨,å†™å…¥ logs/ ç›®å½•
  â”‚
  â”œâ”€â†’ åˆå§‹åŒ– InfluxDB å®¢æˆ·ç«¯
  â”‚     â””â”€â†’ è¿æ¥ 3 ä¸ªæ•°æ®åº“
  â”‚
  â”œâ”€â†’ åŠ è½½æ•°æ®ä¸­å¿ƒé…ç½®
  â”‚     â””â”€â†’ è§£æ uid_config.yaml,æ„å»ºæ•°æ®ä¸­å¿ƒå¯¹è±¡
  â”‚
  â”œâ”€â†’ åˆ›å»ºæ•°æ®è¯»å†™å™¨
  â”‚     â””â”€â†’ ç”¨äºè¯»å†™ InfluxDB æ•°æ®
  â”‚
  â”œâ”€â†’ åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡(AppContext)
  â”‚     â””â”€â†’ å°è£…æ‰€æœ‰å…¨å±€çŠ¶æ€
  â”‚
  â””â”€â†’ å¯åŠ¨å¤šçº¿ç¨‹
        â”‚
        â”œâ”€â†’ é¢„æµ‹è®­ç»ƒçº¿ç¨‹
        â”‚     â””â”€â†’ æ¯ 1 å°æ—¶è®­ç»ƒä¸€æ¬¡æ¨¡å‹
        â”‚
        â”œâ”€â†’ é¢„æµ‹æ¨ç†çº¿ç¨‹
        â”‚     â””â”€â†’ æ¯ 5 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡æ¨ç†
        â”‚
        â””â”€â†’ ä¼˜åŒ–çº¿ç¨‹
              â””â”€â†’ æ¯ 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ä¼˜åŒ–
```

### 7.2 çº¿ç¨‹è¿è¡Œæµç¨‹

```
ä¸»çº¿ç¨‹                é¢„æµ‹è®­ç»ƒçº¿ç¨‹           é¢„æµ‹æ¨ç†çº¿ç¨‹           ä¼˜åŒ–çº¿ç¨‹
  â”‚                      â”‚                      â”‚                    â”‚
  â”‚ å¯åŠ¨çº¿ç¨‹æ±            â”‚                      â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ å¼€å§‹è¿è¡Œ             â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ å¼€å§‹è¿è¡Œ           â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ å¼€å§‹è¿è¡Œ
  â”‚                      â”‚                      â”‚                    â”‚
  â”‚ ç­‰å¾…ä¸­æ–­ä¿¡å·         â”‚ è¯»å–æ•°æ®             â”‚ è¯»å–æ•°æ®           â”‚ è¯»å–æ•°æ®
  â”‚ (sleep 3600ç§’)       â”‚ è®­ç»ƒæ¨¡å‹             â”‚ æ‰§è¡Œæ¨ç†           â”‚ æ‰§è¡Œä¼˜åŒ–
  â”‚                      â”‚ ä¿å­˜æ¨¡å‹             â”‚ å†™å…¥ç»“æœ           â”‚ å†™å…¥æŒ‡ä»¤
  â”‚                      â”‚ ç­‰å¾…ä¸‹ä¸€æ¬¡å¾ªç¯       â”‚ ç­‰å¾…ä¸‹ä¸€æ¬¡å¾ªç¯     â”‚ ç­‰å¾…ä¸‹ä¸€æ¬¡å¾ªç¯
  â”‚                      â”‚                      â”‚                    â”‚
  â”‚ æ”¶åˆ° Ctrl+C          â”‚                      â”‚                    â”‚
  â”‚ è®¾ç½® shutdown_event  â”‚                      â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚ æ£€æµ‹åˆ°å…³é—­ä¿¡å·       â”‚                    â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æ£€æµ‹åˆ°å…³é—­ä¿¡å·     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚ æ£€æµ‹åˆ°å…³é—­ä¿¡å·
  â”‚                      â”‚ é€€å‡ºå¾ªç¯             â”‚ é€€å‡ºå¾ªç¯           â”‚ é€€å‡ºå¾ªç¯
  â”‚                      â”‚ çº¿ç¨‹ç»“æŸ             â”‚ çº¿ç¨‹ç»“æŸ           â”‚ çº¿ç¨‹ç»“æŸ
  â”‚                      â”‚                      â”‚                    â”‚
  â”‚ ç­‰å¾…å…³é”®æ“ä½œå®Œæˆ     â”‚                      â”‚                    â”‚
  â”‚ ç­‰å¾…çº¿ç¨‹é€€å‡º         â”‚                      â”‚                    â”‚
  â”‚ å…³é—­æ•°æ®åº“è¿æ¥       â”‚                      â”‚                    â”‚
  â”‚ åˆ·æ–°æ—¥å¿—             â”‚                      â”‚                    â”‚
  â”‚ ç¨‹åºé€€å‡º             â”‚                      â”‚                    â”‚
```

---

## 8. ä¸å…¶ä»–æ¨¡å—çš„äº¤äº’

### 8.1 æ¨¡å—ä¾èµ–å…³ç³»å›¾

```
main.py
  â”‚
  â”œâ”€â†’ utils/initialization.py
  â”‚     â”œâ”€â†’ load_configs()          # åŠ è½½é…ç½®æ–‡ä»¶
  â”‚     â””â”€â†’ init_multi_level_loggers()  # åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
  â”‚
  â”œâ”€â†’ utils/influxdb_wrapper.py
  â”‚     â”œâ”€â†’ init_influxdb_clients()  # åˆå§‹åŒ– InfluxDB å®¢æˆ·ç«¯
  â”‚     â””â”€â†’ InfluxDBClientWrapper    # InfluxDB å®¢æˆ·ç«¯ç±»
  â”‚
  â”œâ”€â†’ utils/critical_operation.py
  â”‚     â”œâ”€â†’ critical_operation()     # å…³é”®æ“ä½œä¿æŠ¤
  â”‚     â””â”€â†’ wait_for_critical_operations()  # ç­‰å¾…å…³é”®æ“ä½œå®Œæˆ
  â”‚
  â”œâ”€â†’ utils/architecture_config_parser.py
  â”‚     â””â”€â†’ load_datacenter_from_config()  # åŠ è½½æ•°æ®ä¸­å¿ƒé…ç½®
  â”‚
  â”œâ”€â†’ utils/data_read_write.py
  â”‚     â”œâ”€â†’ create_data_reader()     # åˆ›å»ºæ•°æ®è¯»å–å™¨
  â”‚     â””â”€â†’ create_data_writer()     # åˆ›å»ºæ•°æ®å†™å…¥å™¨
  â”‚
  â””â”€â†’ modules/architecture_module.py
        â””â”€â†’ DataCenter               # æ•°æ®ä¸­å¿ƒç±»
```

### 8.2 æ•°æ®æµå‘å›¾

```
InfluxDB (dc_status_data)
  â”‚
  â”‚ è¯»å–é¥æµ‹æ•°æ®
  â†“
DataCenterDataReader
  â”‚
  â”‚ æä¾›æ•°æ®
  â†“
é¢„æµ‹è®­ç»ƒçº¿ç¨‹ â”€â”€â†’ è®­ç»ƒæ¨¡å‹ â”€â”€â†’ ä¿å­˜æ¨¡å‹æ–‡ä»¶
  â”‚
  â†“
é¢„æµ‹æ¨ç†çº¿ç¨‹ â”€â”€â†’ åŠ è½½æ¨¡å‹ â”€â”€â†’ æ‰§è¡Œæ¨ç†
  â”‚                              â”‚
  â”‚                              â”‚ å†™å…¥é¢„æµ‹ç»“æœ
  â”‚                              â†“
  â”‚                         InfluxDB (prediction_data)
  â”‚                              â”‚
  â”‚                              â”‚ è¯»å–é¢„æµ‹æ•°æ®
  â”‚                              â†“
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä¼˜åŒ–çº¿ç¨‹
                                  â”‚
                                  â”‚ æ‰§è¡Œä¼˜åŒ–ç®—æ³•
                                  â”‚
                                  â”‚ å†™å…¥æ§åˆ¶æŒ‡ä»¤
                                  â†“
                            InfluxDB (optimization_data)
```

---

## 9. Python è¯­æ³•å’Œæ¦‚å¿µè§£é‡Š

### 9.1 @dataclass è£…é¥°å™¨

**ä»€ä¹ˆæ˜¯è£…é¥°å™¨?**
è£…é¥°å™¨æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°,ç”¨äºä¿®æ”¹ç±»æˆ–å‡½æ•°çš„è¡Œä¸ºã€‚

**@dataclass çš„ä½œç”¨**:
è‡ªåŠ¨ç”Ÿæˆ `__init__`ã€`__repr__`ã€`__eq__` ç­‰æ–¹æ³•,ç®€åŒ–æ•°æ®ç±»çš„å®šä¹‰ã€‚

**ç¤ºä¾‹å¯¹æ¯”**:

```python
# ä¸ä½¿ç”¨ @dataclass
class Person:
    def __init__(self, name, age):
        self.name = name
        self.age = age
    
    def __repr__(self):
        return f"Person(name={self.name}, age={self.age})"

# ä½¿ç”¨ @dataclass
from dataclasses import dataclass

@dataclass
class Person:
    name: str
    age: int
```

ä¸¤è€…åŠŸèƒ½ç›¸åŒ,ä½† `@dataclass` æ›´ç®€æ´ã€‚

### 9.2 ç±»å‹æç¤º (Type Hints)

**ä½œç”¨**: æé«˜ä»£ç å¯è¯»æ€§,å¸®åŠ© IDE æä¾›æ›´å¥½çš„ä»£ç è¡¥å…¨å’Œé”™è¯¯æ£€æŸ¥ã€‚

**ç¤ºä¾‹**:

```python
def add(a: int, b: int) -> int:
    return a + b

loggers: Dict[str, logging.Logger]  # å­—å…¸,é”®æ˜¯å­—ç¬¦ä¸²,å€¼æ˜¯ Logger å¯¹è±¡
```

**æ³¨æ„**: ç±»å‹æç¤ºä¸ä¼šåœ¨è¿è¡Œæ—¶å¼ºåˆ¶æ£€æŸ¥,åªæ˜¯æç¤ºä½œç”¨ã€‚

### 9.3 ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (Context Manager)

**è¯­æ³•**: `with` è¯­å¥

**ä½œç”¨**: è‡ªåŠ¨ç®¡ç†èµ„æºçš„è·å–å’Œé‡Šæ”¾ã€‚

**ç¤ºä¾‹**:

```python
# æ–‡ä»¶æ“ä½œ
with open("file.txt", "r") as f:
    content = f.read()
# æ–‡ä»¶è‡ªåŠ¨å…³é—­,å³ä½¿å‘ç”Ÿå¼‚å¸¸

# å…³é”®æ“ä½œä¿æŠ¤
with critical_operation(ctx):
    # æ‰§è¡Œå…³é”®æ“ä½œ
    ctx.prediction_client.write_points(data)
# è‡ªåŠ¨æ›´æ–°å…³é”®æ“ä½œè®¡æ•°
```

### 9.4 çº¿ç¨‹å’Œçº¿ç¨‹æ± 

**çº¿ç¨‹**: ç¨‹åºä¸­çš„ä¸€ä¸ªæ‰§è¡Œæµ,å¯ä»¥å¹¶å‘æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚

**çº¿ç¨‹æ± **: ç®¡ç†å¤šä¸ªçº¿ç¨‹çš„å®¹å™¨,é¿å…é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ã€‚

**ç¤ºä¾‹**:

```python
from concurrent.futures import ThreadPoolExecutor

# åˆ›å»ºçº¿ç¨‹æ± 
executor = ThreadPoolExecutor(max_workers=3)

# æäº¤ä»»åŠ¡
future = executor.submit(my_function, arg1, arg2)

# è·å–ç»“æœ
result = future.result()
```

### 9.5 Event å¯¹è±¡

**ä½œç”¨**: çº¿ç¨‹é—´é€šä¿¡,ç”¨äºé€šçŸ¥çº¿ç¨‹æŸä¸ªäº‹ä»¶å‘ç”Ÿã€‚

**æ–¹æ³•**:
- `set()`: è®¾ç½®äº‹ä»¶(é€šçŸ¥)
- `is_set()`: æ£€æŸ¥äº‹ä»¶æ˜¯å¦å·²è®¾ç½®
- `wait(timeout)`: ç­‰å¾…äº‹ä»¶,å¯è®¾ç½®è¶…æ—¶

**ç¤ºä¾‹**:

```python
from threading import Event

event = Event()

# çº¿ç¨‹ 1
event.set()  # å‘é€ä¿¡å·

# çº¿ç¨‹ 2
if event.is_set():
    print("æ”¶åˆ°ä¿¡å·")
```

---

## 10. å¸¸è§é—®é¢˜è§£ç­”

### Q1: ä¸ºä»€ä¹ˆä½¿ç”¨å¤šçº¿ç¨‹è€Œä¸æ˜¯å¤šè¿›ç¨‹?

**ç­”**: 
- **æ•°æ®å…±äº«**: çº¿ç¨‹å…±äº«å†…å­˜,å¯ä»¥æ–¹ä¾¿åœ°å…±äº« `AppContext` å¯¹è±¡
- **èµ„æºå ç”¨**: çº¿ç¨‹æ¯”è¿›ç¨‹æ›´è½»é‡,å ç”¨èµ„æºæ›´å°‘
- **é€‚ç”¨åœºæ™¯**: æœ¬é¡¹ç›®ä¸»è¦æ˜¯ I/O å¯†é›†å‹ä»»åŠ¡(è¯»å†™æ•°æ®åº“),çº¿ç¨‹è¶³å¤Ÿ

### Q2: å¦‚æœçº¿ç¨‹å¡ä½æ— æ³•é€€å‡ºæ€ä¹ˆåŠ?

**ç­”**:
ç¨‹åºè®¾è®¡äº†è¶…æ—¶æœºåˆ¶:
1. ç­‰å¾…å…³é”®æ“ä½œå®Œæˆ: æœ€å¤š 30 ç§’
2. ç­‰å¾…çº¿ç¨‹é€€å‡º: æœ€å¤š 5 ç§’
3. è¶…æ—¶åå¼ºåˆ¶ç»§ç»­å…³é—­æµç¨‹

### Q3: ä¸ºä»€ä¹ˆéœ€è¦ critical_operation ä¿æŠ¤?

**ç­”**:
ç¡®ä¿å…³é”®æ“ä½œ(å¦‚æ•°æ®åº“å†™å…¥ã€æ¨¡å‹ä¿å­˜)ä¸ä¼šè¢«ä¸­æ–­,é¿å…æ•°æ®æŸåæˆ–ä¸¢å¤±ã€‚

### Q4: å¦‚ä½•ä¿®æ”¹çº¿ç¨‹è¿è¡Œé—´éš”?

**ç­”**:
ç¼–è¾‘ `configs/main_config.yaml`:

```yaml
threads:
  prediction_training:
    interval: 7200  # æ”¹ä¸º 2 å°æ—¶
```

### Q5: å¦‚ä½•æ·»åŠ æ–°çš„çº¿ç¨‹?

**ç­”**:
1. å®šä¹‰çº¿ç¨‹å‡½æ•°(å‚è€ƒ `prediction_training_thread`)
2. åœ¨ `main()` ä¸­æäº¤ä»»åŠ¡: `executor.submit(new_thread, ctx)`
3. åœ¨ `finally` å—ä¸­ç­‰å¾…æ–°çº¿ç¨‹é€€å‡º

### Q6: æ—¥å¿—æ–‡ä»¶åœ¨å“ªé‡Œ?

**ç­”**:
æ‰€æœ‰æ—¥å¿—æ–‡ä»¶åœ¨ `logs/` ç›®å½•ä¸‹:
- `total_log.log`: æ‰€æœ‰æ—¥å¿—
- `main_log.log`: ä¸»ç¨‹åºæ—¥å¿—
- `prediction_training_log.log`: é¢„æµ‹è®­ç»ƒæ—¥å¿—
- ç­‰ç­‰

### Q7: å¦‚ä½•è°ƒè¯•ç¨‹åº?

**ç­”**:
1. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶,äº†è§£ç¨‹åºè¿è¡ŒçŠ¶æ€
2. ä¿®æ”¹æ—¥å¿—çº§åˆ«ä¸º `DEBUG`,è·å–æ›´è¯¦ç»†çš„ä¿¡æ¯
3. ä½¿ç”¨ IDE çš„è°ƒè¯•åŠŸèƒ½,è®¾ç½®æ–­ç‚¹

### Q8: ç¨‹åºå¯åŠ¨å¤±è´¥æ€ä¹ˆåŠ?

**ç­”**:
æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹:
1. é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
2. InfluxDB æ˜¯å¦æ­£å¸¸è¿è¡Œ
3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
4. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ“ æ€»ç»“

`main.py` æ˜¯æ•´ä¸ªæ•°æ®ä¸­å¿ƒèŠ‚èƒ½é¡¹ç›®çš„æ ¸å¿ƒ,è´Ÿè´£:

1. **åˆå§‹åŒ–ç³»ç»Ÿ**: åŠ è½½é…ç½®ã€åˆå§‹åŒ–æ—¥å¿—ã€è¿æ¥æ•°æ®åº“
2. **å¯åŠ¨å¤šçº¿ç¨‹**: é¢„æµ‹è®­ç»ƒã€é¢„æµ‹æ¨ç†ã€ä¼˜åŒ–ä¸‰ä¸ªçº¿ç¨‹å¹¶å‘è¿è¡Œ
3. **åè°ƒè¿è¡Œ**: é€šè¿‡ `AppContext` å…±äº«å…¨å±€çŠ¶æ€
4. **ä¼˜é›…å…³é—­**: ç¡®ä¿æ‰€æœ‰èµ„æºæ­£ç¡®é‡Šæ”¾

**å…³é”®è®¾è®¡**:
- **å¤šçº¿ç¨‹æ¶æ„**: æé«˜ç³»ç»Ÿå¹¶å‘æ€§èƒ½
- **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ–‡ä»¶çµæ´»è°ƒæ•´å‚æ•°
- **å®¹é”™æœºåˆ¶**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- **ä¼˜é›…å…³é—­**: ç¡®ä¿æ•°æ®å®Œæ•´æ€§

**ä¸‹ä¸€æ­¥å­¦ä¹ **:
1. äº†è§£å„ä¸ªå·¥å…·æ¨¡å—çš„å®ç°(utils/)
2. å­¦ä¹ æ•°æ®ä¸­å¿ƒæ¶æ„æ¨¡å‹(modules/architecture_module.py)
3. å®ç°é¢„æµ‹å’Œä¼˜åŒ–ç®—æ³•(TODO éƒ¨åˆ†)

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-07  
**ä½œè€…**: Augment Agent

